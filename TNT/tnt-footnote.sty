\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{tnt-footnote}[footnote with circled number and other settings]

\RequirePackage[bottom,perpage,hang]{footmisc}
\RequirePackage{etoolbox}

% 特定长度的脚注分割线
\def\footnoterule{\vspace{-3pt}\hrule\@width0.3\textwidth\@height0.4\p@\vspace{2.6pt}}

% 脚注中的编号默认是上标样式，可改为普通大小。
% 来源：https://www.zhihu.com/question/53030087
\makeatletter
\def\nosuper@makefnmark{\hbox{\normalfont\@thefnmark\space}}
\patchcmd\@makefntext{\@makefnmark}{\nosuper@makefnmark}{}{}
\makeatother
%% 不用 etoolbox 的另一种打临时热补丁的写法
%\let\save@makefntext\@makefntext
%\long\def\@makefntext#1{{%
%  \let\@makefnmark\nosuper@makefnmark
%  \save@makefntext{#1}}}

% 悬挂的脚注格式
\renewcommand\@makefntext[1]{%
  \setlength\leftskip{1.2\ccwd}%
  \setlength\parindent{2\ccwd}\selectfont
  \noindent\llap{\@thefnmark\ }#1}

% 脚注格式与标记的间距
\setlength{\footnotemargin}{1em}

%% 两条脚注之间的竖向间距
\setlength{\footnotesep}{12pt}

%% 将文中和脚注中的符号都改为正文大小
% \makeatletter
% \def\@makefnmark{\hbox{\normalfont\@thefnmark}}
% \makeatother

% 使用带圈数字作为编号
\RequirePackage{tnt-pifont-circlednum}% 调用 Pifont 字体
% pkg{tnt-pifont-circlednum} 优势：精巧好看。劣势：只有1~10可用。
\RequirePackage{tnt-tikz-textcircled}% 在数字外绘制圆形。
% pkg{tnt-tikz-textcircled} 优势：只是绘制圆形，不影响字体等设置。劣势：如果数字/字母过多，则圆形过大。
\RequirePackage{tnt-xuni-textcircled}% 调用xunicode字体。
% pkg{tnt-xuni-textcircled} 优势：可以支持三位数字的编号。劣势：字体不能在此处修改，需要回到 xuni-textcircled 宏包。
% 作为宏包选项
\RequirePackage{kvoptions}
\SetupKeyvalOptions{
  family=ftnt,
  prefix=ftnt@
}
\DeclareStringOption{numstyle}
\newif\ifftnt@pifontrm
\ftnt@pifontrmtrue% 默认使用 pifont 的衬线序号
\newif\ifftnt@pifontsf
\newif\ifftnt@tikzcirc
\newif\ifftnt@xunicirc
\newif\ifftnt@normtype
\define@key{ftnt}{numstyle}{%
  \ftnt@pifontrmfalse% 关闭默认选项
  \csname ftnt@#1true\endcsname}
\ProcessKeyvalOptions*
\def\ftncircled#1{%
  \ifnum\value{#1}>9% 脚注数字最多处理到 9
    \PackageWarning{tnt-footnote}{Too many footnotes in this page. Keep footnote less than 10.}
  \fi% 编号不能过多，所以强烈建议打开 perpage 选项。
  \ifftnt@pifontrm
    \pifontrm{#1}% pifont 接受的就是 <counter>
  \else \ifftnt@pifontsf
    \pifontsf{#1}% pifont 接受的就是 <counter>
  \else \ifftnt@tikzcirc
    \tikzcircled{\arabic{#1}}% tikz 接受的是文字
  \else \ifftnt@xunicirc
    \xunicircled{\arabic{#1}}% xuni 接受的是文字
  \else \ifftnt@normtype
    {\footnotesize \arabic{#1}}% 普通等等文字
  \fi
  \fi
  \fi
  \fi
  \fi
}
\renewcommand\thefootnote{\ftncircled{footnote}}
\renewcommand\thempfootnote{\ftncircled{mpfootnote}}% minipage footnote

% 脚注中编号与文字间距
\footnotemargin1.5em

% 脚注文字格式
\renewcommand{\footnotelayout}{\itshape}
